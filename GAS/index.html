<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="A fully featured admin theme which can be used to build CRM, CMS, etc.">
        <meta name="author" content="Coderthemes">

        

        <title>Velonic - Responsive Admin Dashboard Template</title>
      <script>
        var LT = new Date().getTime();
        var jquery_min_js = false;
        var jquery_ui_js = false;
        var backendless_min_js = false;
        var taffy_min_js = false;
        var bootstrap_min_css = false;
        var bootstrap_min_js = true;
        function load_timer(text){
          var et = new Date().getTime();
          console.log(((et-LT)/1000).toFixed(4) + ' seconds ' + text);
//          if( ( (jquery_min_js && jquery_ui_js) && (backendless_min_js && taffy_min_js) ) && (bootstrap_min_css && bootstrap_min_js) ){get_t32_customer_data_initial();}
        }
      </script>
        <link rel="shortcut icon" href="img/favicon_1.ico" onload="load_timer('Loaded: '+this.href);">
        
        <!-- Google-Fonts -->
        <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:100,300,400,600,700,900,400italic' rel='stylesheet' onload="load_timer('Loaded: '+this.href);">

        <!-- Bootstrap core CSS -->

        <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:100,300,400,600,700,900,400italic' rel='stylesheet' onload="load_timer('Loaded: '+this.href);">
        <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet" onload="load_timer('Loaded: '+this.href);">
        
        <!-- Bootstrap core CSS -->
        <link href="https://rawgit.com/mjbertken/blackhat/master/bootstrap.min.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);">
        <link href="https://rawgit.com/mjbertken/blackhat/master/bootstrap-reset.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);">
        
        <!--Animation css-->
        <link href="https://rawgit.com/mjbertken/blackhat/master/animate.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);">
        
        <!--Icon-fonts css-->
        <link href="https://rawgit.com/mjbertken/blackhat/master/font-awesome/css/font-awesome.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);"/>
        <link href="https://rawgit.com/mjbertken/blackhat/master/ionicon/css/ionicons.min.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);"/>
        
        <!-- DataTables -->
        <link href="https://rawgit.com/mjbertken/blackhat/master/assets/datatables/jquery.dataTables.min.css" rel="stylesheet" type="text/css" onload="load_timer('Loaded: '+this.href);"/>
        
        <!--Morris Chart CSS -->
        <link rel="stylesheet" href="https://rawgit.com/mjbertken/blackhat/master/morris/morris.css" onload="load_timer('Loaded: '+this.href);">
        
        <!--TauCharts -->
        <script src="//cdn.jsdelivr.net/d3js/3.5.17/d3.min.js" charset="utf-8" onload="load_timer('Loaded: '+this.src);"></script>
        <script src="//cdn.jsdelivr.net/npm/taucharts@1/build/production/tauCharts.min.js" type="text/javascript" onload="load_timer('Loaded: '+this.src);"></script>
        <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/taucharts@1/build/production/tauCharts.min.css" onload="load_timer('Loaded: '+this.href);">
        
        <!-- Plugins css -->
        <link href="https://rawgit.com/mjbertken/blackhat/master/modaleffectcomponent.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);"/>
        <link href="https://rawgit.com/mjbertken/blackhat/master/timepicker/bootstrap-timepicker.min.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);"/>
        <link href="https://rawgit.com/mjbertken/blackhat/master/timepicker/bootstrap-datepicker.min.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);"/>
        
        <!-- sweet alerts -->
        <link href="https://rawgit.com/mjbertken/blackhat/master/sweet-alert/sweet-alert.min.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);"/>
        
        <!-- Custom styles for this template -->
        <!--<link href="css/style.css" rel="stylesheet">-->
        <link href="https://rawgit.com/mjbertken/blackhat/master/style.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);">
        <link href="https://rawgit.com/mjbertken/blackhat/master/helper.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);">
        <link href="https://rawgit.com/mjbertken/blackhat/master/style-responsive.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);"/>
        
        <link href="https://rawgit.com/mjbertken/blackhat/master/c3-chart/c3.css" rel="stylesheet" onload="load_timer('Loaded: '+this.href);"/>
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 tooltipss and media queries -->
        <!--[if lt IE 9]>
          <script src="https://rawgit.com/mjbertken/blackhat/master/js/html5shiv.js" onload="load_timer('Loaded: '+this.src);"></script>
          <script src="https://rawgit.com/mjbertken/blackhat/master/js/respond.min.js" onload="load_timer('Loaded: '+this.src);"></script>
        <![endif]-->


    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" onload="jquery_min_js = true; load_timer('Loaded: '+this.src); "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js" onload="jquery_ui_js = true; load_timer('Loaded: '+this.src);"></script>
    <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js" onload="backendless_min_js = true; load_timer('Loaded: '+this.src);"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/taffydb/2.7.3/taffy-min.js" onload="taffy_min_js = true; load_timer('Loaded: '+this.src);"></script>
    
        <!-- Moment js -->
        <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js" onload="load_timer('Loaded: '+this.src);"></script>
    
    <!-- Boostrap -->
      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" onload="bootstrap_min_css = true; load_timer('Loaded: '+this.src);">
      <!-- Latest compiled JavaScript -->
      <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" onload="bootstrap_min_js = true; load_timer('Loaded: '+this.src);"></script>-->
    <!-- Boostrap End -->

<style>
.pct:after{
content: "%";
}
.money:before{
content: "$";
}
</style>
<script id="handlebars-widget-panel" type="text/x-handlebars-template">
      {{#if isnew}}
<div id="handlebars-widget-panel_{{container_id}}" class="col-xs-6 col-sm-3 col-md-2">
      {{/if}}
  <div class="widget-panel widget" change="{{change}}" up-good="{{up_good}}">
    <h2>{{title}}</h2>
    <h1 class="m-0 {{value_class}}" value="{{value}}">{{value_text}}</h1>
    <h3>
      <span class="widget-arrow widget-arrow-{{change}} glyphicon glyphicon-arrow-{{change}}"></span>
      <span class="widget-change {{change_class}}">{{change_val}}</span>
    </h3>
  </div>
        {{#if isnew}}
  </div>
      {{/if}}
</script>
<script id="handlebars-top-x-panel" type="text/x-handlebars-template">
      {{#if isnew}}
<div id="handlebars-top-x-panel_{{container_id}}" class="col-xs-6 col-sm-3 col-md-2">
      {{/if}}
        {{#each comments}}
  <div>{{test}} </div>
  {{/each}}

        {{#if isnew}}
  </div>
      {{/if}}
</script>
    </head>


    <body>

        <!-- Aside Start-->
        <aside class="left-panel">

            <!-- brand -->
            <div class="logo">
                <a href="" class="logo-expanded">
                    <img src="https://rawgit.com/mjbertken/blackhat/master/img/single-logo.png" alt="logo">
                    <span class="nav-label">Velonic</span>
                </a>
            </div>
            <!-- / brand -->
        
            <!-- Navbar Start -->
            <nav class="navigation">
                <ul class="list-unstyled">
                    <li class="has-submenu"><a href="#"><i class="ion-location"></i> <span class="nav-label">Maps</span></a>
                        <ul class="list-unstyled">
                            <li><a href="gmap.html"> Google Map</a></li>
                            <li><a href="vector-map.html"> Vector Map</a></li>
                        </ul>
                    </li>
                    <li class="has-submenu"><a href="#"><i class="ion-document"></i> <span class="nav-label">Pages</span></a>
                        <ul class="list-unstyled">
                            <li><a href="profile.html">Profile</a></li>
                            <li><a href="timeline.html">Timeline</a></li>
                            <li><a href="invoice.html">Invoice</a></li>
                            <li><a href="contact.html">Contact-list</a></li>
                            <li><a href="login.html">Login</a></li>
                            <li><a href="register.html">Register</a></li>
                            <li><a href="recoverpw.html">Recover Password</a></li>
                            <li><a href="lock-screen.html">Lock Screen</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
                
        </aside>
        <!-- Aside Ends-->


        <!--Main Content Start -->
        <section class="content">
            
            <!-- Header -->
            <header class="top-head container-fluid">
                <button type="button" class="navbar-toggle pull-left">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <!-- Search -->
                <form role="search" class="navbar-left app-search pull-left hidden-xs">
                  <input type="text" placeholder="Search..." class="form-control">
                </form>
                <!-- Left navbar -->
<div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 300px; margin-top:10px;">
    <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
    <span></span> <b class="caret"></b>
</div>
                
                
                <nav class=" navbar-default hidden-xs" role="navigation">
                    <ul class="nav navbar-nav">

                    </ul>
                </nav>
            </header>
            <!-- Header Ends -->


            <!-- Page Content Start -->
            <!-- ================== -->

            <div class="wraper container-fluid">
                <div id="widget-row" class="row">
                </div> <!-- end row -->
                <div class="row">
                  <!-- START BILLBOARDJS TEST-->
<!-- Load D3.js -->
<script src="https://d3js.org/d3.v4.min.js"></script>

<!-- Load billboard.js with style -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/billboard.js/1.1.1/billboard.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/billboard.js/1.1.1/billboard.js"></script>
<div class="col-lg-6 col-md-12">
  <div id="chart"></div>
</div>
<style>
.chart-panel-container{
  padding-left: 5px;
  padding-right: 5px;
}
.chart-panel{
  margin: 5px;
-webkit-box-shadow: 2px 2px 11px -1px rgba(112,108,112,0.47);
-moz-box-shadow: 2px 2px 11px -1px rgba(112,108,112,0.47);
box-shadow: 2px 2px 11px -1px rgba(112,108,112,0.47);
  padding-left: 0px;
  padding-right: 0px;
  border-radius: 4px;
}
.chart-header{
  text-align: center;
  font-weight: bold;
  font-size: 1.2em;
}
.chart-container{
  padding-left:0px;
  padding-right:0px;
  margin-left: -15px;
}
.bb-line {
    stroke-width: 1.5px !important;
}
</style>
<script>
function draw_bb_time_chart(obj,bindto_selector){// obj = SESSIONS_SALES_X_DATE;

//var arr = obj.COLUMNS.DATA;
//arr = jQuery.grep(arr, function( a ) {
//  return a == 15;
//});
//console.log(arr);
var arr = [];//obj.COLUMNS.DATA;
var data_arg = {};
var axis_arg = {};
//console.log(obj);
if(obj.COLUMNS.DATA[0][0]=='x'){
  data_arg['x']="x";
}
//data_arg['columns']=obj.COLUMNS.DATA;
//console.log('------------------');
//console.log(obj.COLUMNS.DATA);
data_arg['axes']={};
data_arg['type']="bar";
data_arg['types']={};
if(obj.CHART_CONFIG['PRINT_ROWS']){
  if(obj.COLUMNS.DATA[0][0]=='x'){
    arr.push(obj.COLUMNS.DATA[0]);
  }
  for(var p=0;p<obj.CHART_CONFIG['PRINT_ROWS'].length;p++){
    var d = obj.CHART_CONFIG['PRINT_ROWS'][p];
    data_arg['axes'][obj.COLUMNS.DATA[d][0]]=obj.COLUMNS.CONFIG[d].AXIS;
    data_arg['types'][obj.COLUMNS.DATA[d][0]]=obj.COLUMNS.CONFIG[d].TYPE;
    arr.push(obj.COLUMNS.DATA[d]);
  }
  data_arg['columns'] = arr;
}
else{
  data_arg['columns'] = obj.COLUMNS.DATA;
  for(var d=1;d<obj.COLUMNS.DATA.length;d++){
    data_arg['axes'][obj.COLUMNS.DATA[d][0]]=obj.COLUMNS.CONFIG[d].AXIS;
    data_arg['types'][obj.COLUMNS.DATA[d][0]]=obj.COLUMNS.CONFIG[d].TYPE;
  }
}



if(obj.COLUMNS.DATA[0][0]=='x'){
  axis_arg['x']={};
  axis_arg['x']['type']="timeseries";
  axis_arg['x']['tick']={};
  axis_arg['x']['tick']['format']="%Y-%m-%d";
}


axis_arg['y2']={};
axis_arg['y2']['show']=obj.CHART_CONFIG['SHOW_Y2'];//true;
var size_arg ={};
size_arg['height']=381;
var bindto_arg = bindto_selector;//".chart-test"// "#chart"

var chart_data = {
  data: data_arg,
  size: size_arg,
  axis:axis_arg,
  bindto: bindto_arg
};
var chart = bb.generate(chart_data);
}
</script>
                  <!-- END BILLBOARDJS TEST-->
                </div> <!-- end row -->
                <div id="lead-source-container" class="container-fluid" style="border: 1px solid black;">
                  <div class="row" style="border: 1px solid red;">
                      <div class="col-lg-6">
                      Lead Source
                      </div><!-- end col-->
                      <div class="col-lg-6">
                        <select class="form-control input-sm" id="lead-source-select">
                          <option></option>
                        </select>
                      </div><!-- end col-->
                  </div> <!-- end row -->
                  <div class="row chart-row" style="border: 1px solid red;">
                      <div class="col-lg-12 chart-container" id="lead-source-chart-1">
                      </div><!-- end col-->
                  </div> <!-- end row -->
                  <div class="row chart-row">
                      <div class="col-lg-6 chart-panel-container">
                        <div class="col-lg-12 chart-panel">
                          <div class="col-lg-12 chart-header" chartid="avg-mmr-x-lead-source">Average MMR by Lead Source</div>
                          <div class="col-lg-12 chart-container" id="avg-mmr-x-lead-source"></div><!-- end col-->
                        </div><!-- end col-->
                      </div><!-- end col-->
                      <div class="col-lg-6 chart-panel-container">
                        <div class="col-lg-12 chart-panel">
                          <div class="col-lg-12 chart-header" chartid="avg-mmr-x-sales-rep">Average MMR by Sales Rep</div>
                          <div class="col-lg-12 chart-container" id="avg-mmr-x-sales-rep"></div><!-- end col-->
                        </div><!-- end col-->
                      </div><!-- end col-->
                      <div class="col-lg-6 chart-panel-container">
                        <div class="col-lg-12 chart-panel">
                          <div class="col-lg-12 chart-header" chartid="avg-mmr-x-credit-range">Average MMR by Credit Range</div>
                          <div class="col-lg-12 chart-container" id="avg-mmr-x-credit-range"></div><!-- end col-->
                        </div><!-- end col-->
                      </div><!-- end col-->
                  </div> <!-- end row -->
                </div> <!-- end lead-source-container -->
            </div>
            
            
            
            <!-- Page Content Ends -->
            <!-- ================== -->

            <!-- Footer Start -->
            <footer class="footer">
                Black Hat Security
            </footer>
            <!-- Footer Ends -->
        </section>
        <!-- Main Content Ends -->
        


        <!-- js placed at the end of the document so the pages load faster -->
        <script src="https://rawgit.com/mjbertken/blackhat/master/js/jquery.js" onload="load_timer('Loaded: '+this.src);"></script>
        <script src="https://rawgit.com/mjbertken/blackhat/master/js/bootstrap.min.js" onload="load_timer('Loaded: '+this.src);"></script>
        <script src="https://rawgit.com/mjbertken/blackhat/master/js/modernizr.min.js" onload="load_timer('Loaded: '+this.src);"></script>
        <script src="https://rawgit.com/mjbertken/blackhat/master/js/pace.min.js" onload="load_timer('Loaded: '+this.src);"></script>
        <script src="https://rawgit.com/mjbertken/blackhat/master/js/wow.min.js" onload="load_timer('Loaded: '+this.src);"></script>
        <script src="https://rawgit.com/mjbertken/blackhat/master/js/jquery.scrollTo.min.js" onload="load_timer('Loaded: '+this.src);"></script>
        <script src="https://rawgit.com/mjbertken/blackhat/master/js/jquery.nicescroll.js" type="text/javascript" onload="load_timer('Loaded: '+this.src);"></script>
        
        <!-- HandlebarsJS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.js" onload="load_timer('Loaded: '+this.src);"></script>
        
        <!-- Counter-up -->
        <script src="https://rawgit.com/mjbertken/blackhat/master/js/waypoints.min.js" type="text/javascript" onload="load_timer('Loaded: '+this.src);"></script>
        <script src="https://rawgit.com/mjbertken/blackhat/master/js/jquery.counterup.min.js" type="text/javascript" onload="load_timer('Loaded: '+this.src);"></script>

        <!-- EASY PIE CHART JS -->
        <script src="https://rawgit.com/mjbertken/blackhat/master/easypie-chart/easypiechart.min.js" onload="load_timer('Loaded: '+this.src);"></script>
        <script src="https://rawgit.com/mjbertken/blackhat/master/easypie-chart/jquery.easypiechart.min.js" onload="load_timer('Loaded: '+this.src);"></script>
        <script src="https://rawgit.com/mjbertken/blackhat/master/easypie-chart/example.js" onload="load_timer('Loaded: '+this.src);"></script>


        <!-- Moment js -->
        <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js" onload="load_timer('Loaded: '+this.src);"></script>
    
    <!-- Include Date Range Picker documentation: http://www.daterangepicker.com/#usage-->
<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js" onload="load_timer('Loaded: '+this.src);"></script>
<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" onload="load_timer('Loaded: '+this.src);"/>




        <script type="text/javascript">
        /* ==============================================
             Counter Up
             =============================================== */
            jQuery(document).ready(function($) {
                $('.counter').counterUp({
                    delay: 100,
                    time: 1200
                });
            });
String.prototype.replaceAll = function(search, replacement) {
  var target = this;
  return target.split(search).join(replacement);
};

google.script.run.withSuccessHandler(success_content_head).getContent('UTILITIES.html');
function success_content_head(data) {
$('head').append(data);
//console.log('-----------------------');
};
            jQuery(document).ready(function($) {
               google.script.run.withSuccessHandler(success_content_util).getTemplateContent('widget_panel_setup.html','.wraper.container-fluid > .row');
             });

//             jQuery(document).ready(function($) {
//               google.script.run.withSuccessHandler(success_content_util).getTemplateContent('widget_panel_template.html','.wraper.container-fluid > .row');
//             });
            /** smart_table_setup.html must be loaded prior to any smart_table_templates **/
//            jQuery(document).ready(function($) {
//               google.script.run.withSuccessHandler(success_content_util).getTemplateContent('smart_table_setup.html','.wraper.container-fluid > .row');
//             });
//
//                
//             jQuery(document).ready(function($) {
//               google.script.run.withSuccessHandler(success_content_util).getTemplateContent('template.html','.wraper.container-fluid > .row');
//             });
//             jQuery(document).ready(function($) {
//               google.script.run.withSuccessHandler(success_content_util).getTemplateContent('smart_table_template.html','.wraper.container-fluid > .row');
//             });
//             jQuery(document).ready(function($) {
//               google.script.run.withSuccessHandler(success_content_util).getTemplateContent('smart_table_template.html','.wraper.container-fluid > .row');
//             });

            function success_content_util(data) {
              var elm_select = data.element_selector;//data[0];
              var html_data = data.html_content;//data[1];
              var template = data.template;
              if(template=='widget_panel_template.html'){
                var options_obj = data.options;
                var variables_obj = options_obj.variables;
                jQuery.each(variables_obj, function(name, value) {
                  html_data = html_data.replaceAll('{{%'+name+'%}}' , value);
                });
                if(options_obj.container_id){
                  html_data = html_data.replaceAll('{{%container_id%}}' , options_obj.container_id);
                  if( $('#'+options_obj.container_id).length > 0 ){ //id already exists - proceed to empty the existing element
                     $('#'+options_obj.container_id).empty();
                     var inner = $(html_data).find('#'+options_obj.container_id).html();
//                     console.log(inner);
                  }
                }
              }
              
              $(elm_select).append(html_data);
              if(template=='smart_table_template.html'){init_smart_tables()};
            };


var formatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  minimumFractionDigits: 2,
  // the default value for minimumFractionDigits depends on the currency
  // and is usually already 2
});

Number.prototype.round = function(decimals) {
 var num = this;
        var n = Math.pow(10, decimals);
        return Math.round( (n * num).toFixed(decimals) )  / n;
}

Number.prototype.formatNumber = function(shorten, hideUnnecessaryDecimals) {
  var number = this;
  var fnum;
  var prefix = "";
  var suffix = "";
  if(number>=1000000000){
    fnum = +(number/1000000000)//.toFixed(decimals_max);
    suffix = "B"
  } 
  else if(number>=1000000){
    fnum = +(number/1000000)//.toFixed(decimals_max);
    suffix = "M"
  }
  else if(number>=1000){
    fnum = +(number/1000)//.toFixed(decimals_max);
    suffix = "K"
  }
  else if(number<1000){
    fnum = (number);//+0.001//.toFixed(decimals_max);
    suffix = ""
  }
  var text = fnum.round(2);//Math.round(fnum);
  return prefix+text+suffix;//target.split(search).join(replacement);
};


function ga_top_x(data_type_arg){
  var data_type_arg = 'Sales Count by Lead Source';
  var data_type = data_type_arg.toUpperCase().replaceAll(' ','_');
  var data = {
    "container_id":'container-'+data_type_arg.replaceAll(' ','_'),
    "title":data_type_arg.toProperCase(),
    "value_class":'',
    "value":GA[data_type]['AZ'].CUR,
    "compare_value":GA[data_type]['AZ'].COMP,
    "change_class":'pct',
    "up_good":GA[data_type]['UP_GOOD'],
  }
  data['value_text'] = data['value'].formatNumber(true,true);   
  if (GA[data_type]['PCT']){
    data['value_class']='pct'
    var chg = (data['value'] - data['compare_value']);
  }else{
    var chg = (((data['value'] - data['compare_value']) / data['compare_value'])*100).round(1);
  }
  if(chg>0){data['change']="up"};
  if(chg==0){data['change']=""};
  if(chg<0){data['change']="down"};
  data['change_val'] = Math.abs(chg);
  build_widget_panel(data);
}

function build_top_x_panel(context){
//context = '';
//console.log('test');
var context = {
  title: {firstName: "Alan", lastName: "Johnson"},
  body: "I Love Handlebars",
  comments: [{
    author: {firstName: "Yehuda", lastName: "Katz"},
    test: "Me sdfs!"
  },{
    author: {firstName: "Yehuda", lastName: "Katz"},
    test: "Me too!"
  }]
};
context['isnew']=true;
var template_id = 'handlebars-top-x-panel';
var theTemplateScript = $("#"+template_id).html();
var theTemplate = Handlebars.compile(theTemplateScript);
var target_parent = '.wraper.container-fluid > .row';
var theCompiledHtml = theTemplate(context);
$(target_parent).append(theCompiledHtml);
}

function build_widget_panel(context){
  var template_id = 'handlebars-widget-panel';
  // Grab the template script
  var theTemplateScript = $("#"+template_id).html();

  // Compile the template
  var theTemplate = Handlebars.compile(theTemplateScript);
  
  // Add the compiled html to the page
  
  var target_parent = '#widget-row';
  var exists = $(target_parent).find('#'+template_id+'_'+context.container_id).length;
  if(exists>0){context['isnew']=false}else{context['isnew'] = true};
  var theCompiledHtml = theTemplate(context);
  
  if(exists>0){$(target_parent).find('#'+template_id+'_'+context.container_id).html(theCompiledHtml)}
  if(exists==0){$(target_parent).append(theCompiledHtml)}


}

var testid = 0;

function generate_widgets(){
  ga_widget('sessions');
  t32_widget('website leads');
  ga_widget('page views');
  ga_widget('bounce rate');
  ga_widget('in market traffic');
  t32_widget('referral leads');
  t32_widget('avg credit score');
}

//T32.REFERRAL_LEADS.CUR
function t32_widget(data_type_arg){
  data_type = data_type_arg.toUpperCase().replaceAll(' ','_');
  var data = {
    "container_id":'container-'+data_type_arg.replaceAll(' ','_'),
    "title":data_type_arg.toProperCase(),
    "value_class":'',
    "value":T32[data_type].CUR,
    "compare_value":T32[data_type].COMP,
    "change_class":'pct',
    "up_good":T32[data_type]['UP_GOOD'],
  }
  data['value_text'] = data['value'].formatNumber(true,true);   
  if (T32[data_type]['PCT']){
    data['value_class']='pct'
    var chg = (data['value'] - data['compare_value']);
  }else{
    var chg = (((data['value'] - data['compare_value']) / data['compare_value'])*100).round(1);
  }
  if(chg=='Infinity'){
    data['change_val'] = 0;
    data['change'] = 'change-na';
    data['change_class'] = '';
  } else{
    if(chg>0){data['change']="up"};
    if(chg==0){data['change']=""};
    if(chg<0){data['change']="down"};
    data['change_val'] = Math.abs(chg);
  }
  build_widget_panel(data);
}
function ga_widget(data_type_arg){
  data_type = data_type_arg.toUpperCase().replaceAll(' ','_');
  var data = {
    "container_id":'container-'+data_type_arg.replaceAll(' ','_'),
    "title":data_type_arg.toProperCase(),
    "value_class":'',
    "value":GA[data_type]['AZ'].CUR,
    "compare_value":GA[data_type]['AZ'].COMP,
    "change_class":'pct',
    "up_good":GA[data_type]['UP_GOOD'],
  }
  data['value_text'] = data['value'].formatNumber(true,true);   
  if (GA[data_type]['PCT']){
    data['value_class']='pct'
    var chg = (data['value'] - data['compare_value']);
  }else{
    var chg = (((data['value'] - data['compare_value']) / data['compare_value'])*100).round(1);
  }
  if(chg=='Infinity'){
    data['change_val'] = 0;
    data['change'] = 'change-na';
    data['change_class'] = '';
  } else{
    if(chg>0){data['change']="up"};
    if(chg==0){data['change']=""};
    if(chg<0){data['change']="down"};
    data['change_val'] = Math.abs(chg);
  }
  build_widget_panel(data);
}


        </script>


<script type="text/javascript">
var START_DATE;
var THRU_DATE;
var DATE_CHANGE_COUNTER=0;
$(function() {

    var start = moment().subtract(89, 'days');
    var end = moment();

    function cb(start, end) {
        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
        START_DATE = start.format('YYYY-MM-DD');
        END_DATE = end.format('YYYY-MM-DD');
//        console.log(START_DATE);
//        console.log(END_DATE);
        if(DATE_CHANGE_COUNTER>0){
          calculate();
        }
        DATE_CHANGE_COUNTER = DATE_CHANGE_COUNTER +1 ;
//        console.log('DATE_CHANGE_COUNTER: '+ DATE_CHANGE_COUNTER);
    }

    $('#reportrange').daterangepicker({
        startDate: start,
        endDate: end,
        ranges: {
           'Today': [moment(), moment()],
           'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Last 14 Days': [moment().subtract(13, 'days'), moment()],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'Last 45 Days': [moment().subtract(44, 'days'), moment()],
           'Last 60 Days': [moment().subtract(59, 'days'), moment()],
           'Last 90 Days': [moment().subtract(89, 'days'), moment()],
           'This Month': [moment().startOf('month'), moment()],
           'This Year': [moment().startOf('year'), moment()],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    }, cb);

    cb(start, end);
    
});
</script>

    <script>
    var DB_T32 = TAFFY(); var DB_T32_DCUR; var DB_T32_DCOMP;
    var DB_GA = TAFFY(); var DB_GA_DCUR; var DB_GA_DCOMP;
    
    var GA = {
      SESSIONS : {PCT:false,UP_GOOD:true},
      PAGE_VIEWS : {PCT:false,UP_GOOD:true},
      BOUNCE_RATE : {PCT:true,UP_GOOD:false},
      IN_MARKET_TRAFFIC : {PCT:true,UP_GOOD:true}
    }
    var T32 = {
      REFERRAL_LEADS : {PCT:false,UP_GOOD:true},
      AVG_CREDIT_SCORE : {PCT:false,UP_GOOD:true},
      WEBSITE_LEADS : {PCT:false,UP_GOOD:true},
      MMR_X_LEAD_SOURCE : {PCT:false,UP_GOOD:true},
      LEAD_SOURCES : {PCT:false,UP_GOOD:true, COUNT_CUR:[], COUNT_COMP:[], MMR_ALL:[], MMR_SUM_CUR:[], MMR_SUM_COMP:[], MMR_AVG_CUR:[], MMR_AVG_COMP:[]},
      SALES_REPS : {PCT:false,UP_GOOD:true, COUNT_CUR:[], COUNT_COMP:[], MMR_ALL:[], MMR_SUM_CUR:[], MMR_SUM_COMP:[], MMR_AVG_CUR:[], MMR_AVG_COMP:[]}
      CREDIT_RANGES : {PCT:false,UP_GOOD:true, COUNT_CUR:[], COUNT_COMP:[], MMR_ALL:[], MMR_SUM_CUR:[], MMR_SUM_COMP:[], MMR_AVG_CUR:[], MMR_AVG_COMP:[]}
    }
    SESSIONS_SALES_X_DATE = {CHART_CONFIG:{},DATA:[],COLUMNS:{CONFIG:[],DATA:[]}};
    LEAD_SOURCE_X_DATE = {CHART_CONFIG:{},DATA:[],COLUMNS:{CONFIG:[],DATA:[]}};
    AVG_MMR_X_LEAD_SOURCE = {CHART_CONFIG:{},DATA:[],COLUMNS:{CONFIG:[],DATA:[]}};
    AVG_MMR_X_SALES_REP = {CHART_CONFIG:{},DATA:[],COLUMNS:{CONFIG:[],DATA:[]}};
    AVG_MMR_X_CREDIT_RANGE = {CHART_CONFIG:{},DATA:[],COLUMNS:{CONFIG:[],DATA:[]}};
    
    jQuery(document).ready(function($) {
      google.script.run.withSuccessHandler(success_t32_and_ga).get_t32_data_and_ga();
    });
    function success_t32_and_ga(arr){
      var t32 = arr[0];//obj.t32;
      var ga = arr[1];//obj.ga;
      addToDb(DB_T32,t32,'DB_T32');
      addToDb(DB_GA,ga,'DB_GA');
      calculate();
//        $('input[name="datefilter"]').daterangepicker();
    }
    
    
    function addToDb(arg_db,arg_arr,text){
      for(var r=0;r<arg_arr.length;r++){
        var obj = arg_arr[r];
        arg_db.insert(obj);
      }
      var et = new Date().getTime();
        load_timer('addToDb('+text+') complete');
    }
    
function calculate(){
  load_timer('calculate start');
  DB_T32_DCUR = '';
  DB_GA_DCUR = '';
  DB_T32_DCOMP = '';
  DB_GA_DCOMP = '';
  var techs = DB_T32().distinct("Technician");
  var filt = DB_T32().filter({Technician:"ERNESTO MENDEZ"}).count();
  var filt_2 = DB_T32().filter({Technician:"ERNESTO MENDEZ"}).filter({Status:"INSTALLED"}).count();
  
  var start_date = iso8601_to_date(START_DATE);
  var end_date = new Date(iso8601_to_date(END_DATE).setHours(23));
  end_date = new Date(end_date.setMinutes(59));
  end_date = new Date(end_date.setSeconds(59));
  
  var day_diff = moment(end_date).diff(moment(start_date), 'days');
  load_timer('day_diff calculated : '+day_diff);
  var comp_end_date = new Date(moment(start_date).subtract(1, 'day').format());
  comp_end_date = new Date(comp_end_date.setHours(23));
  comp_end_date = new Date(comp_end_date.setMinutes(59));
  comp_end_date = new Date(comp_end_date.setSeconds(59));

  var comp_start_date = new Date(moment(comp_end_date).subtract(day_diff, 'day').format());
  comp_start_date = new Date(comp_start_date.setHours(23));
  comp_start_date = new Date(comp_start_date.setMinutes(59));
  comp_start_date = new Date(comp_start_date.setSeconds(59));

  var dt_start_serial = start_date.getUnixTimeStamp();//new Date(2017,11,1).getUnixTimeStamp();
  var dt_end_serial = end_date.getUnixTimeStamp();//new Date(2018,0,23).getUnixTimeStamp();

  var dt_comp_start_serial = comp_start_date.getUnixTimeStamp();//new Date(2017,11,1).getUnixTimeStamp();
  var dt_comp_end_serial = comp_end_date.getUnixTimeStamp();//new Date(2018,0,23).getUnixTimeStamp();

  load_timer('day_diff calculate : '+day_diff);
  load_timer('Start Date: '+start_date);  
  load_timer('End Date: '+end_date);  
  load_timer('Comp Start Date: '+comp_start_date);
  load_timer('Comp End Date: '+comp_end_date);
  
  DB_T32_DCUR = DB_T32().filter({ShortSaleDate:{gte:dt_start_serial}}).filter({ShortSaleDate:{lte:dt_end_serial}});
  DB_T32_DCOMP = DB_T32().filter({ShortSaleDate:{gte:dt_comp_start_serial}}).filter({ShortSaleDate:{lte:dt_comp_end_serial}});
  DB_GA_DCUR = DB_GA().filter({date:{gte:dt_start_serial}}).filter({date:{lte:dt_end_serial}});
  DB_GA_DCOMP = DB_GA().filter({date:{gte:dt_comp_start_serial}}).filter({date:{lte:dt_comp_end_serial}});
  
  GA.SESSIONS['AZ'] = {
    CUR : DB_GA_DCUR.sum("sessions_az"),
    COMP : DB_GA_DCOMP.sum("sessions_az")
  };
  GA.PAGE_VIEWS['AZ'] = {
    CUR : DB_GA_DCUR.sum("page_views_az"),
    COMP : DB_GA_DCOMP.sum("page_views_az")
  };
  GA.BOUNCE_RATE['AZ'] = {
    CUR : ((DB_GA_DCUR.sum("bounced_sessions_az")/DB_GA_DCUR.sum("sessions_az"))*100).round(0),
    COMP : ((DB_GA_DCOMP.sum("bounced_sessions_az")/DB_GA_DCUR.sum("sessions_az"))*100).round(0)
  };
  GA.IN_MARKET_TRAFFIC['AZ'] = {
    CUR : ((DB_GA_DCUR.sum("sessions_az")/DB_GA_DCUR.sum("sessions_all"))*100).round(0),
    COMP : ((DB_GA_DCOMP.sum("sessions_az")/DB_GA_DCUR.sum("sessions_all"))*100).round(0)
  };

  T32.REFERRAL_LEADS.CUR = DB_T32_DCUR.filter({'LeadSource':'Customer Referral'}).count();
  T32.REFERRAL_LEADS.COMP = DB_T32_DCOMP.filter({'LeadSource':'Customer Referral'}).count();
  
  T32.WEBSITE_LEADS.CUR = DB_T32_DCUR.filter({'LeadSource':'Website Form'}).count();
  T32.WEBSITE_LEADS.COMP = DB_T32_DCOMP.filter({'LeadSource':'Website Form'}).count();
  
  var sum = 0; var count = 0;
  DB_T32_DCUR.filter({CreditScore:{isNull:false}}).filter({CreditScore:{gte:1}}).each(function (record,recordnumber) {sum = sum + ( record["CreditScore"] * 1)});
  var count =  DB_T32_DCUR.filter({CreditScore:{isNull:false}}).filter({CreditScore:{gte:1}}).count();
  if(count>0){T32.AVG_CREDIT_SCORE.CUR = Math.round(sum/count)}else{T32.AVG_CREDIT_SCORE.CUR = 0};

  var sum = 0; var count = 0;
  DB_T32_DCOMP.filter({CreditScore:{isNull:false}}).filter({CreditScore:{gte:1}}).each(function (record,recordnumber) {sum = sum + ( record["CreditScore"] * 1)});
  var count =  DB_T32_DCOMP.filter({CreditScore:{isNull:false}}).filter({CreditScore:{gte:1}}).count();
  if(count>0){T32.AVG_CREDIT_SCORE.COMP = Math.round(sum/count)}else{T32.AVG_CREDIT_SCORE.COMP = 0};
  
  generate_widgets();




//  MMR_X_LEAD_SOURCE
  var selected_id = $('#lead-source-select option:selected').attr('id');
  $('#lead-source-select').html('');

  T32.LEAD_SOURCES['UNIQUE_LIST']= DB_T32().distinct("LeadSource");
  T32.LEAD_SOURCES['UNIQUE_LIST'].sort(col1Asc);
  var g1_tot = 0;
  var g2_tot = 0;
  LEAD_SOURCE_X_DATE.CHART_CONFIG['SHOW_Y2'] = false;
  LEAD_SOURCE_X_DATE.DATA = [];
  LEAD_SOURCE_X_DATE.COLUMNS.DATA = [];
  LEAD_SOURCE_X_DATE.COLUMNS.DATA.push(["x"]);
  LEAD_SOURCE_X_DATE.COLUMNS.CONFIG.push({AXIS:"x",TYPE:'timeseries'});
  for(var l=0;l<T32.LEAD_SOURCES['UNIQUE_LIST'].length;l++){
    if(T32.LEAD_SOURCES['UNIQUE_LIST'][l]!==''){
      LEAD_SOURCE_X_DATE.COLUMNS.DATA.push([T32.LEAD_SOURCES['UNIQUE_LIST'][l]]);
      LEAD_SOURCE_X_DATE.COLUMNS.CONFIG.push({AXIS:"y",TYPE:'bar'});
      var option = document.createElement('option');
      
      var ls_id = DB_T32_DCUR.filter({'LeadSource':T32.LEAD_SOURCES['UNIQUE_LIST'][l]}).first().LeadSourceId;
      if(!ls_id){
        $(option).html(T32.LEAD_SOURCES['UNIQUE_LIST'][l]+' [No data]');
      }else{
        $(option).html(T32.LEAD_SOURCES['UNIQUE_LIST'][l]);
      }
      $(option).attr('chart-key',l+1);
      $(option).attr('id',ls_id);
      $('#lead-source-select').append(option);
    }
  }
  $('#lead-source-select').find('#'+selected_id).attr('selected', true);
  for(var d=0;d<=day_diff;d++){
    var dt = new Date(moment(start_date).add(d, 'day').format());
    var et = new Date(moment(start_date).add(d+1, 'day').format());
    var st_ser = dt.getUnixTimeStamp();
    var et_ser = et.getUnixTimeStamp();
    LEAD_SOURCE_X_DATE.COLUMNS.DATA[0].push(jsdate_to_iso8601(dt));
    
    for(var l=0;l<T32.LEAD_SOURCES['UNIQUE_LIST'].length;l++){
      if(T32.LEAD_SOURCES['UNIQUE_LIST'][l]!==''){
//        LEAD_SOURCE_X_DATE.COLUMNS.DATA.push([T32.LEAD_SOURCES['UNIQUE_LIST'][l]]);
        var c = DB_T32().filter({ShortInstallDate:{gte:st_ser}}).filter({ShortInstallDate:{lte:et_ser}}).filter({LeadSource:LEAD_SOURCE_X_DATE.COLUMNS.DATA[l][0]}).count();
        if(c===undefined){c=0};
        if(l>0){
          LEAD_SOURCE_X_DATE.COLUMNS.DATA[l].push(c);
        }
      }
    }
    var g1 = DB_T32().filter({ShortInstallDate:{gte:st_ser}}).filter({ShortInstallDate:{lte:et_ser}}).filter({LeadSource:'INSTALLED'}).count();
    var g2 = DB_GA().filter({date:st_ser}).first().sessions_az;
    if(g2===undefined){g2=0};
    g1_tot = g1_tot + g1;
    g2_tot = g2_tot + g2;
  }


  T32.LEAD_SOURCES['UNIQUE_LIST']= DB_T32().distinct("LeadSource");
  for(var l=0;l<T32.LEAD_SOURCES['UNIQUE_LIST'].length;l++){
    var ls = T32.LEAD_SOURCES['UNIQUE_LIST'][l];
    if(ls!==''){
      var count_cur = DB_T32_DCUR.filter({'LeadSource':T32.LEAD_SOURCES['UNIQUE_LIST'][l]}).count();
      var count_comp = DB_T32_DCOMP.filter({'LeadSource':T32.LEAD_SOURCES['UNIQUE_LIST'][l]}).count();
      var mmr_count_cur = DB_T32_DCUR.filter({'LeadSource':T32.LEAD_SOURCES['UNIQUE_LIST'][l]}).filter({'MonthlyMonitoringBaseRate':{gte:0.01}}).count();
      var mmr_count_comp = DB_T32_DCOMP.filter({'LeadSource':T32.LEAD_SOURCES['UNIQUE_LIST'][l]}).filter({'MonthlyMonitoringBaseRate':{gte:0.01}}).count();
      var mmr_sum_cur = DB_T32_DCUR.filter({'LeadSource':T32.LEAD_SOURCES['UNIQUE_LIST'][l]}).sum("MonthlyMonitoringBaseRate");
      var mmr_sum_comp = DB_T32_DCOMP.filter({'LeadSource':T32.LEAD_SOURCES['UNIQUE_LIST'][l]}).sum("MonthlyMonitoringBaseRate");
      var mmr_avg_cur = averageCatch(mmr_sum_cur,mmr_count_cur,0,2);
      var mmr_avg_comp = averageCatch(mmr_sum_comp,count_comp,0,2);

      T32.LEAD_SOURCES['MMR_ALL'].push([ls,mmr_count_cur*1,mmr_count_comp*1,mmr_sum_cur*1,mmr_sum_comp*1,mmr_avg_cur*1,mmr_avg_comp*1]);
      T32.LEAD_SOURCES['COUNT_CUR'].push([ls,count_cur*1]);
      T32.LEAD_SOURCES['COUNT_COMP'].push([ls,count_comp*1]);
      T32.LEAD_SOURCES['MMR_SUM_CUR'].push([ls,mmr_sum_cur*1]);
      T32.LEAD_SOURCES['MMR_SUM_COMP'].push([ls,mmr_sum_comp*1]);
      T32.LEAD_SOURCES['MMR_AVG_CUR'].push([ls,mmr_avg_cur*1]);
      T32.LEAD_SOURCES['MMR_AVG_COMP'].push([ls,mmr_avg_comp*1]);
    }
  }

  T32.SALES_REPS['UNIQUE_LIST']= DB_T32().distinct("SalesRep");
  for(var l=0;l<T32.SALES_REPS['UNIQUE_LIST'].length;l++){
    var ls = T32.SALES_REPS['UNIQUE_LIST'][l];
    if(ls!==''){
      var count_cur = DB_T32_DCUR.filter({'SalesRep':T32.SALES_REPS['UNIQUE_LIST'][l]}).count();
      var count_comp = DB_T32_DCOMP.filter({'SalesRep':T32.SALES_REPS['UNIQUE_LIST'][l]}).count();
      var mmr_count_cur = DB_T32_DCUR.filter({'SalesRep':T32.SALES_REPS['UNIQUE_LIST'][l]}).filter({'MonthlyMonitoringBaseRate':{gte:0.01}}).count();
      var mmr_count_comp = DB_T32_DCOMP.filter({'SalesRep':T32.SALES_REPS['UNIQUE_LIST'][l]}).filter({'MonthlyMonitoringBaseRate':{gte:0.01}}).count();
      var mmr_sum_cur = DB_T32_DCUR.filter({'SalesRep':T32.SALES_REPS['UNIQUE_LIST'][l]}).sum("MonthlyMonitoringBaseRate");
      var mmr_sum_comp = DB_T32_DCOMP.filter({'SalesRep':T32.SALES_REPS['UNIQUE_LIST'][l]}).sum("MonthlyMonitoringBaseRate");
      var mmr_avg_cur = averageCatch(mmr_sum_cur,mmr_count_cur,0,2);
      var mmr_avg_comp = averageCatch(mmr_sum_comp,count_comp,0,2);

      T32.SALES_REPS['MMR_ALL'].push([ls,mmr_count_cur*1,mmr_count_comp*1,mmr_sum_cur*1,mmr_sum_comp*1,mmr_avg_cur*1,mmr_avg_comp*1]);
      T32.SALES_REPS['COUNT_CUR'].push([ls,count_cur*1]);
      T32.SALES_REPS['COUNT_COMP'].push([ls,count_comp*1]);
      T32.SALES_REPS['MMR_SUM_CUR'].push([ls,mmr_sum_cur*1]);
      T32.SALES_REPS['MMR_SUM_COMP'].push([ls,mmr_sum_comp*1]);
      T32.SALES_REPS['MMR_AVG_CUR'].push([ls,mmr_avg_cur*1]);
      T32.SALES_REPS['MMR_AVG_COMP'].push([ls,mmr_avg_comp*1]);
    }
  }

/*
  T32.CREDIT_RANGES['UNIQUE_LIST']= [['Bad',380,599],['Poor',600,649],['Fair',650,699],['Good',700,749],['Great',750,799],['Excellent',800,999]];
  for(var l=0;l<T32.CREDIT_RANGES['UNIQUE_LIST'].length;l++){
    var ls = T32.CREDIT_RANGES['UNIQUE_LIST'][l][0];
    var min = T32.CREDIT_RANGES['UNIQUE_LIST'][l][0];
    var max = T32.CREDIT_RANGES['UNIQUE_LIST'][l][0];
    var testest = DB_T32_DCUR.sum("CreditScore");
    console.log('test test '+testest);
    if(ls!==''){
      var count_cur = DB_T32_DCUR.filter({'CreditScore':T32.SALES_REPS['UNIQUE_LIST'][l]}).count();
      var count_comp = DB_T32_DCOMP.filter({'SalesRep':T32.SALES_REPS['UNIQUE_LIST'][l]}).count();
      var mmr_count_cur = DB_T32_DCUR.filter({'SalesRep':T32.SALES_REPS['UNIQUE_LIST'][l]}).filter({'MonthlyMonitoringBaseRate':{gte:0.01}}).count();
      var mmr_count_comp = DB_T32_DCOMP.filter({'SalesRep':T32.SALES_REPS['UNIQUE_LIST'][l]}).filter({'MonthlyMonitoringBaseRate':{gte:0.01}}).count();
      var mmr_sum_cur = DB_T32_DCUR.filter({'SalesRep':T32.SALES_REPS['UNIQUE_LIST'][l]}).sum("MonthlyMonitoringBaseRate");
      var mmr_sum_comp = DB_T32_DCOMP.filter({'SalesRep':T32.SALES_REPS['UNIQUE_LIST'][l]}).sum("MonthlyMonitoringBaseRate");
      var mmr_avg_cur = averageCatch(mmr_sum_cur,mmr_count_cur,0,2);
      var mmr_avg_comp = averageCatch(mmr_sum_comp,count_comp,0,2);

      T32.SALES_REPS['MMR_ALL'].push([ls,mmr_count_cur*1,mmr_count_comp*1,mmr_sum_cur*1,mmr_sum_comp*1,mmr_avg_cur*1,mmr_avg_comp*1]);
      T32.SALES_REPS['COUNT_CUR'].push([ls,count_cur*1]);
      T32.SALES_REPS['COUNT_COMP'].push([ls,count_comp*1]);
      T32.SALES_REPS['MMR_SUM_CUR'].push([ls,mmr_sum_cur*1]);
      T32.SALES_REPS['MMR_SUM_COMP'].push([ls,mmr_sum_comp*1]);
      T32.SALES_REPS['MMR_AVG_CUR'].push([ls,mmr_avg_cur*1]);
      T32.SALES_REPS['MMR_AVG_COMP'].push([ls,mmr_avg_comp*1]);
    }
  }
*/


  
/* AVG MMR X LEAD SOURCE */
T32.LEAD_SOURCES['UNIQUE_LIST']= DB_T32().distinct("LeadSource");
T32.LEAD_SOURCES['UNIQUE_LIST'].sort(col1Asc);

AVG_MMR_X_LEAD_SOURCE.CHART_CONFIG['TARGET_ID'] = '#avg-mmr-x-lead-source';
AVG_MMR_X_LEAD_SOURCE.CHART_CONFIG['SHOW_Y2'] = false;
AVG_MMR_X_LEAD_SOURCE.CHART_CONFIG['SHOW_POINTS'] = false;
AVG_MMR_X_LEAD_SOURCE.CHART_CONFIG['HEIGHT'] = 400;
AVG_MMR_X_LEAD_SOURCE.CHART_CONFIG['Y'] = {};
AVG_MMR_X_LEAD_SOURCE.CHART_CONFIG.Y['PREFIX'] = '$';
AVG_MMR_X_LEAD_SOURCE.CHART_CONFIG['Y2'] = {};
AVG_MMR_X_LEAD_SOURCE.CHART_CONFIG.Y2['PREFIX'] = '$';
AVG_MMR_X_LEAD_SOURCE.DATA = [];
AVG_MMR_X_LEAD_SOURCE.COLUMNS.DATA = [];
var data_arr = T32.LEAD_SOURCES['MMR_ALL'];
data_arr.sort(col6Desc);
  AVG_MMR_X_LEAD_SOURCE.COLUMNS.DATA.push([]);
  AVG_MMR_X_LEAD_SOURCE.COLUMNS.CONFIG.push([]);
  
  AVG_MMR_X_LEAD_SOURCE.COLUMNS.DATA.push(['Total MMR']);
  AVG_MMR_X_LEAD_SOURCE.COLUMNS.CONFIG.push([{TYPE:'bar',COLOR:'rgb(35, 131, 193)',AXIS:'y'}]);
  
  AVG_MMR_X_LEAD_SOURCE.COLUMNS.DATA.push(['Avg MMR']);
  AVG_MMR_X_LEAD_SOURCE.COLUMNS.CONFIG.push([{TYPE:'bar',COLOR:'#ffb74d',AXIS:'y2'}]);
  
  AVG_MMR_X_LEAD_SOURCE.COLUMNS.DATA.push(['Overall Avg']);
  AVG_MMR_X_LEAD_SOURCE.COLUMNS.CONFIG.push([{TYPE:'line',COLOR:'#ff4444',AXIS:'y2'}]);

var ovr_mmr_count_cur = DB_T32_DCUR.filter({'MonthlyMonitoringBaseRate':{gte:0.01}}).count();
var ovr_mmr_sum_cur = DB_T32_DCUR.sum("MonthlyMonitoringBaseRate");
var ovr_mmr_avg_cur = averageCatch(ovr_mmr_sum_cur,ovr_mmr_count_cur,0,2);
  var chart_data_arr = [];
for(var l=0;l<data_arr.length;l++){
  if(data_arr[l][1]>0){
    AVG_MMR_X_LEAD_SOURCE.COLUMNS.DATA[0].push(data_arr[l][0]);
    AVG_MMR_X_LEAD_SOURCE.COLUMNS.DATA[1].push(data_arr[l][3]);
    AVG_MMR_X_LEAD_SOURCE.COLUMNS.DATA[2].push(data_arr[l][5]);
    AVG_MMR_X_LEAD_SOURCE.COLUMNS.DATA[3].push(ovr_mmr_avg_cur);
  }
}
  draw_bb_chart(AVG_MMR_X_LEAD_SOURCE);
  /* END OF AVG MMR X LEAD SOURCE */ 

/* AVG MMR X SALES REP */
//AVG_MMR_X_SALES_REP
var OBJ = {CHART_CONFIG:{},DATA:[],COLUMNS:{CONFIG:[],DATA:[]}};
T32.SALES_REPS['UNIQUE_LIST'] = DB_T32().distinct("SalesRep");
T32.SALES_REPS['UNIQUE_LIST'].sort(col1Asc);
console.log(T32.SALES_REPS['UNIQUE_LIST']);
OBJ.CHART_CONFIG['TARGET_ID'] = '#avg-mmr-x-sales-rep';
OBJ.CHART_CONFIG['SHOW_Y2'] = false;
OBJ.CHART_CONFIG['SHOW_POINTS'] = false;
OBJ.CHART_CONFIG['HEIGHT'] = 400;
OBJ.CHART_CONFIG['Y'] = {};
OBJ.CHART_CONFIG.Y['PREFIX'] = '$';
OBJ.CHART_CONFIG['Y2'] = {};
OBJ.CHART_CONFIG.Y2['PREFIX'] = '$';
OBJ.DATA = [];
OBJ.COLUMNS.DATA = [];
var data_arr = T32.SALES_REPS['MMR_ALL'];
data_arr.sort(col6Desc);
  OBJ.COLUMNS.DATA.push([]);
  OBJ.COLUMNS.CONFIG.push([]);
  
  OBJ.COLUMNS.DATA.push(['Total MMR']);
  OBJ.COLUMNS.CONFIG.push([{TYPE:'bar',COLOR:'rgb(35, 131, 193)',AXIS:'y'}]);
  
  OBJ.COLUMNS.DATA.push(['Avg MMR']);
  OBJ.COLUMNS.CONFIG.push([{TYPE:'bar',COLOR:'#ffb74d',AXIS:'y2'}]);
  
  OBJ.COLUMNS.DATA.push(['Overall Avg']);
  OBJ.COLUMNS.CONFIG.push([{TYPE:'line',COLOR:'#ff4444',AXIS:'y2'}]);

var ovr_mmr_count_cur = DB_T32_DCUR.filter({'MonthlyMonitoringBaseRate':{gte:0.01}}).count();
var ovr_mmr_sum_cur = DB_T32_DCUR.sum("MonthlyMonitoringBaseRate");
var ovr_mmr_avg_cur = averageCatch(ovr_mmr_sum_cur,ovr_mmr_count_cur,0,2);
//  var chart_data_arr = [];
for(var l=0;l<data_arr.length;l++){
  if(data_arr[l][1]>0){
    OBJ.COLUMNS.DATA[0].push(data_arr[l][0]);
    OBJ.COLUMNS.DATA[1].push(data_arr[l][3]);
    OBJ.COLUMNS.DATA[2].push(data_arr[l][5]);
    OBJ.COLUMNS.DATA[3].push(ovr_mmr_avg_cur);
  }
}
AVG_MMR_X_SALES_REP = OBJ;
  draw_bb_chart(AVG_MMR_X_SALES_REP);
/* AVG MMR BY SALES REP */  
  
  var g1_tot = 0;
  var g2_tot = 0;
  SESSIONS_SALES_X_DATE.CHART_CONFIG['SHOW_Y2'] = true;
  SESSIONS_SALES_X_DATE.DATA = [];
  SESSIONS_SALES_X_DATE.COLUMNS.DATA = [];
  SESSIONS_SALES_X_DATE.COLUMNS.DATA.push(["x"]);
  SESSIONS_SALES_X_DATE.COLUMNS.DATA.push(["Installs"]);
  SESSIONS_SALES_X_DATE.COLUMNS.DATA.push(["Web Sessions"]);
  SESSIONS_SALES_X_DATE.COLUMNS.CONFIG.push({AXIS:"x",TYPE:'timeseries'});
  SESSIONS_SALES_X_DATE.COLUMNS.CONFIG.push({AXIS:"y",TYPE:'bar'});
  SESSIONS_SALES_X_DATE.COLUMNS.CONFIG.push({AXIS:"y2",TYPE:'line'});
  
  for(var d=0;d<=day_diff;d++){
    var dt = new Date(moment(start_date).add(d, 'day').format());
    var et = new Date(moment(start_date).add(d+1, 'day').format());
    var st_ser = dt.getUnixTimeStamp();
    var et_ser = et.getUnixTimeStamp();
    var g1 = DB_T32().filter({ShortInstallDate:{gte:st_ser}}).filter({ShortInstallDate:{lte:et_ser}}).filter({Status:'INSTALLED'}).count();
    var g2 = DB_GA().filter({date:st_ser}).first().sessions_az;//.sum('sessions_az');
    if(g2===undefined){g2=0};
    g1_tot = g1_tot + g1;
    g2_tot = g2_tot + g2;
    SESSIONS_SALES_X_DATE.COLUMNS.DATA[0].push(jsdate_to_iso8601(dt));
    SESSIONS_SALES_X_DATE.COLUMNS.DATA[1].push(g1);
    SESSIONS_SALES_X_DATE.COLUMNS.DATA[2].push(g2);
  }
//  console.log(g1_tot);
//  console.log(g2_tot);

draw_bb_time_chart(SESSIONS_SALES_X_DATE,'#chart');


  T32.LEAD_SOURCES['COUNT_CUR'].sort(col2Desc);
  T32.LEAD_SOURCES['COUNT_COMP'].sort(col2Desc);
  T32.LEAD_SOURCES['MMR_SUM_CUR'].sort(col2Desc);
  T32.LEAD_SOURCES['MMR_SUM_COMP'].sort(col2Desc);
  T32.LEAD_SOURCES['MMR_AVG_CUR'].sort(col2Desc);
  T32.LEAD_SOURCES['MMR_AVG_COMP'].sort(col2Desc);
  
  
//  console.log(T32.LEAD_SOURCES['COUNT_CUR']);
//  console.log(T32.LEAD_SOURCES['COUNT_COMP']);
//  console.log(T32.LEAD_SOURCES['MMR_SUM_CUR']);
//  console.log(T32.LEAD_SOURCES['MMR_SUM_COMP']);
//  console.log(T32.LEAD_SOURCES['MMR_AVG_CUR']);
//  console.log(T32.LEAD_SOURCES['MMR_AVG_COMP']);
//  console.log(T32.LEAD_SOURCES['UNIQUE_LIST']);
  
  load_timer('GA.SESSIONS.AZ.CUR: '+GA.SESSIONS.AZ.CUR);
  load_timer('GA.SESSIONS.AZ.COMP: '+GA.SESSIONS.AZ.COMP);

  load_timer('T32.WEBSITE_LEADS.CUR: '+T32.WEBSITE_LEADS.CUR);
  load_timer('T32.WEBSITE_LEADS.COMP: '+T32.WEBSITE_LEADS.COMP);
  
  load_timer('GA.PAGE_VIEWS.AZ.CUR: '+GA.PAGE_VIEWS.AZ.CUR);
  load_timer('GA.PAGE_VIEWS.AZ.COMP: '+GA.PAGE_VIEWS.AZ.COMP);
  
  load_timer('GA.BOUNCE_RATE.AZ.CUR: '+GA.BOUNCE_RATE.AZ.CUR);
  load_timer('GA.BOUNCE_RATE.AZ.COMP: '+GA.BOUNCE_RATE.AZ.COMP);

  load_timer('GA.IN_MARKET_TRAFFIC.AZ.CUR: '+GA.IN_MARKET_TRAFFIC.AZ.CUR);
  load_timer('GA.IN_MARKET_TRAFFIC.AZ.COMP: '+GA.IN_MARKET_TRAFFIC.AZ.COMP);
  
  load_timer('T32.REFERRAL_LEADS.CUR: '+T32.REFERRAL_LEADS.CUR);
  load_timer('T32.REFERRAL_LEADS.COMP: '+T32.REFERRAL_LEADS.COMP);

  load_timer('T32.AVG_CREDIT_SCORE.CUR: '+T32.AVG_CREDIT_SCORE.CUR);
  load_timer('T32.AVG_CREDIT_SCORE.COMP: '+T32.AVG_CREDIT_SCORE.COMP);

//  var filt_dt_count = FILT_DT.count()
//  console.log(filt_dt_count);
  
//  LEAD_SOURCES = DB_T32_DCUR.distinct("LeadSource");//db().distinct("LeadSource");
//  LEAD_SOURCES = DB_T32_DCOMP.distinct("LeadSource");//db().distinct("LeadSource");
//  console.log('xx');
//  console.log(LEAD_SOURCES);
//  console.log('xx');
//  for(var v=0;v<LEAD_SOURCES.length;v++){
////      console.log('LEAD SOURCE: ' + LEAD_SOURCES[v] + ' COUNT: ' + db().filter({LeadSource:LEAD_SOURCES[v]}).count());
//  } 
  
  
//  tech_chart(FILT_DT);
//console.log('calculate() complete'); 
//tech_chart();
//leads_by_lead_source_chart();
//cs_by_lead_source_chart();
//mmr_by_lead_source_chart();
//installs_x_tech_chart();

}

$(document).on('change',"#lead-source-select",function (e) {

  var chart_key = $('#lead-source-select option:selected').attr('chart-key');
  LEAD_SOURCE_X_DATE.CHART_CONFIG['PRINT_ROWS'] = [chart_key*1];
  draw_bb_time_chart(LEAD_SOURCE_X_DATE,'#lead-source-chart-1');
});

    </script>

<script>
var MOUSE_X = 0;
var MOUSE_Y = 0;
$(document).ready(function(){
  $(document).mousemove(function(e){
     MOUSE_X = e.pageX;
     MOUSE_Y = e.pageY;
  });
});
function test_mmr(){
var totalMMR_arr = ['Total MMR',123,421,280];
var avgMMR_arr = ['Avg MMR',24,26,29];
var targetMMR_arr = ['Target MMR',50,50,50];
var lSource_arr = ['LsourceA','LsourceB','LsourceC'];
var dataArr = [];
dataArr.push(totalMMR_arr,avgMMR_arr,targetMMR_arr,lSource_arr);
draw_bb_chart(dataArr);
}
//test_mmr();


function draw_bb_chart(OBJ){


console.log(OBJ);

  var mmrTot =OBJ.COLUMNS.DATA[1];
  var mmrAvg = OBJ.COLUMNS.DATA[2];
  var mmrTar = OBJ.COLUMNS.DATA[3];
  var ls   = OBJ.COLUMNS.DATA[0];

//AVG_MMR_X_LEAD_SOURCE.COLUMNS.CONFIG.push([{TYPE:'LINE'}]);
var GENERATE_OBJ = {};
GENERATE_OBJ['data'] = {};
GENERATE_OBJ['data']['columns']=[];
for(var c = 1;c<OBJ.COLUMNS.DATA.length;c++){
  GENERATE_OBJ['data']['columns'].push(OBJ.COLUMNS.DATA[c]);
}
//GENERATE_OBJ['data']['columns'] = [mmrTot,mmrAvg,mmrTar];
GENERATE_OBJ['data']['type'] = 'bar';

GENERATE_OBJ['data']['types'] = {};
GENERATE_OBJ['data']['colors'] = {};
GENERATE_OBJ['data']['axes'] = {};
for(var c = 1;c<OBJ.COLUMNS.CONFIG.length;c++){
  GENERATE_OBJ['data']['types'][OBJ.COLUMNS.DATA[c][0]] = OBJ.COLUMNS.CONFIG[c][0]['TYPE'];
  GENERATE_OBJ['data']['colors'][OBJ.COLUMNS.DATA[c][0]] = OBJ.COLUMNS.CONFIG[c][0]['COLOR'];
  GENERATE_OBJ['data']['axes'][OBJ.COLUMNS.DATA[c][0]] = OBJ.COLUMNS.CONFIG[c][0]['AXIS'];
}

GENERATE_OBJ['size'] = {};
GENERATE_OBJ['size']['height'] = OBJ.CHART_CONFIG['HEIGHT']; 

GENERATE_OBJ['axis'] = {};
GENERATE_OBJ['axis']['y'] = {};
GENERATE_OBJ['axis']['y']['tick'] = {format: function(x) {if ( x >= 1000 ){x = (x/1000).toFixed(1)+'k'} else {x=x.toFixed(2)};return OBJ.CHART_CONFIG.Y['PREFIX']+x;}};
GENERATE_OBJ['axis']['y2'] = {};
GENERATE_OBJ['axis']['y2']['show'] = true;
GENERATE_OBJ['axis']['y2']['tick'] = {format: function(x) {if ( x >= 1000 ){x = (x/1000).toFixed(1)+'k'} else {x=x.toFixed(2)};return OBJ.CHART_CONFIG.Y2['PREFIX']+x;}};
GENERATE_OBJ['axis']['x'] = {};
GENERATE_OBJ['axis']['x']['type']='category';
GENERATE_OBJ['axis']['x']['categories']=OBJ.COLUMNS.DATA[0];
GENERATE_OBJ['axis']['x']['tick']={};
GENERATE_OBJ['axis']['x']['tick']['rotate']=90;
GENERATE_OBJ['axis']['x']['tick']['multiline']=false;

GENERATE_OBJ['point'] = {};
GENERATE_OBJ['point']['show'] = true;

GENERATE_OBJ['legend'] = {};
GENERATE_OBJ['legend']['show'] = true;
if(GENERATE_OBJ['legend']['show']){
  GENERATE_OBJ['legend']['position'] = 'inset';
//  GENERATE_OBJ['legend']['item'] ={};
//  GENERATE_OBJ['legend']['item']['onclick'] = function(id) { $(GENERATE_OBJ['bindto']).find('.bb-legend-item').parent().attr('transform','translate(0, 1)') };
//  GENERATE_OBJ['legend']['contents'] ={};
//  GENERATE_OBJ['legend']['contents']['bindto'] = '#avg-mmr-x-lead-source'
}
GENERATE_OBJ['bindto'] =OBJ.CHART_CONFIG.TARGET_ID;//"#lead-source-chart-1",
GENERATE_OBJ['tooltip'] = {};
GENERATE_OBJ['tooltip']['show'] = true;
if(!OBJ.CHART_CONFIG.SHOW_POINTS){
  GENERATE_OBJ['point']={};
  GENERATE_OBJ['point']['show']=false;
}
if(GENERATE_OBJ['tooltip']['show']){
  GENERATE_OBJ['tooltip']['position'] = function(data, width, height, element) {
     var toolTipWidth = 150;
     var chartDivSelector = GENERATE_OBJ['bindto'];
     var top = $(GENERATE_OBJ['bindto']).parent().offset().top; 
     var left = $(GENERATE_OBJ['bindto']).parent().offset().left; 
     var right = parseInt($(GENERATE_OBJ['bindto']).parent().css('width').replace('px','')); 
     var oright = MOUSE_X-((left+right) + $(window).scrollLeft());
     var offset = (toolTipWidth/2)*-1;
     var Y = (MOUSE_Y-(top - $(window).scrollTop()))-480;
     var X = MOUSE_X-(left - $(window).scrollLeft())+offset;
     if ( X < 0 ){X=0};
     if ( (oright) > ((toolTipWidth/2)*-1) ){X=(right-(toolTipWidth))};
         return {top: 0, left: X}
     }
}
AVG_MMR_X_LEAD_SOURCE.CHART_CONFIG['SHOW_POINTS']
//GENERATE_OBJ['padding']={};
//GENERATE_OBJ['padding']['top']=18;

bb.generate(GENERATE_OBJ);
$(GENERATE_OBJ['bindto']).css('overflow','hidden');
}

</script>


    </body>
</html>
